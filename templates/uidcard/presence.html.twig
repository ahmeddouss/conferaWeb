{% extends 'session/chart.html.twig' %}
{% block bottomContend %}

<div class="Widget" style="margin-top: 30px">
<h1>{{ session.sessionname }}</h1>
<div class="table-wrapper" style="margin-bottom: 20px">
    <table class="my-table" style="width: 800px">
        <thead>
        <tr>
            <th>Username</th>
            <th>Mail</th>
            <th>UID</th>
            <th>Status</th>
        </tr>
        </thead>
        <tbody>
        {% if users %}
            {% for user in users %}
                <tr>
                    <td style="font-weight: 700; color: #3E3838">{{ user.username }}</td>

                    {% set test = 0 %}
                    {% set test2 = 0 %}
                    {% for uidcard in uidcards | reverse %}
                        {% if uidcard.idparticipant == user and test == 0 %}
                            {% set test = uidcard.uid %}
                            <td>
                                {% if uidcard.uid | length == 8 %}
                                    <div class="pinType">
                                        <div class="E3124" style=" font-size: 12px;">{{ uidcard.uid[:2] }}****{{ uidcard.uid[-2:] }}</div>
                                        <div class="Pin" style="color: #ffffff; font-size: 9px; font-weight: 500;">PIN</div>
                                    </div>
                                {% else %}
                                    <div class="pinType" style="background-color: #665E5E">
                                        <div class="E3124" style=" font-size: 12px;">{{ uidcard.uid[:2] }}****{{ uidcard.uid[-2:] }}</div>
                                        <div class="Pin" style="color: #fcfcfc; font-size: 9px; font-weight: 500;">QR</div>
                                    </div>
                                {% endif %}
                            </td>
                            <td>{{ user.mail }}</td>
                            {% if uidcard.idsession == session.id and test2 == 0 %}
                                {% set test2 = uidcard.idsession %}
                                <td>
                                    <div class="pinType" style="background-color: #D8ECDA; border-width: 0; padding: 4px 10px;">
                                        <div class="E3124" style="font-size: 12px; color: #24A225;">Present</div>
                                    </div>
                                </td>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    {% if test == 0 %}

                        <td></td>
                        <td>{{ user.mail }}</td>
                    {% endif %}
                    {% if test2 == 0 %}
                        <td>
                            <div class="pinType" style="background-color: #EC565C; border-width: 0; padding: 4px 10px;">
                                <div class="E3124" style="font-size: 12px; color: #A00E28;">Absent</div>
                            </div>
                        </td>
                    {% endif %}
                </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="4">No records found</td>
            </tr>
        {% endif %}
        </tbody>
    </table>

</div>
    {{ include('bundles/MercurySeriesFlashy/flashy.html.twig') }}
</div>
    <script>
        var test = window.location.href;
        const eventSource = new EventSource("{{ mercure('http://192.168.1.13/rfid')|escape('js') }}");
        eventSource.onmessage = event => {
            if (JSON.parse(event.data).status !== "new") {
                // Extract the base URL without the endpoint added after '/'
                var baseUrl = test.substring(0, test.lastIndexOf('/'));
                // Add your new endpoint here, for example:
                var newEndpoint = "/";
                // Construct the new URL
                var newUrl = baseUrl + newEndpoint + JSON.parse(event.data).username + " is " + JSON.parse(event.data).status;
                window.location.href = newUrl;
            }
        }
    </script>


{% endblock %}