{% extends 'F_base.html.twig' %}

{% block conference %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.3.0/main.min.css" integrity="sha256-uq9PNlMzB+1h01Ij9cx7zeE2OR2pLAfRw3uUUOOPKdA=" crossorigin="anonymous">

    <div class="container">
        <div class="articles-container">
            <section class="articles">
                {% for conference in conferences %}

                    <article id="{{ conference.id }}">
                        <div class="article-wrapper">
                            <figure>
                                <img src="{{ asset('images/' ~ conference.image) }}">
                            </figure>
                            <div class="share-buttons">
                                <a class="twitter" target="blank"><i class="fab fa-twitter"></i></a>
                            </div>
                            <div class="article-body">
                                <h2>{{ conference.nom }}</h2>
                                <p>{{ conference.date ? conference.date|date('Y-m-d') : '' }}</p>
                                <p>Location: {{ conference.emplacement.gouvernourat }}, {{ conference.emplacement.ville }}, {{ conference.emplacement.label }}</p>

                                <a  class="read-more">
                                    Read more
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </article>

                    <div id="myModal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>Conference Details</h2>
                            <p id="articleDetails"></p>
                            <details open>
                                <summary>
                                    Conference Details

                                </summary>
                                <div  >
                                    <div id="location">Location: {{ conference.emplacement.gouvernourat }}, {{ conference.emplacement.ville }}, {{ conference.emplacement.label }}</div>
                                    <div id="private" >Private: {{ conference.typeconf ? 'Yes' : 'No' }}</div>
                                    <div id="sujet">More Details About Conference:<br>  {{ conference.sujet }}</div>
                                </div>
                            </details>

                        </div>
                    </div>

                {% endfor %}
            </section>
        </div>
        <div class="calendar-container">
            <div id="calendar-holder"></div>
        </div>
    </div>
    <script>
        const title = encodeURIComponent('Article or Post Title Here');
        document.querySelectorAll('.twitter').forEach((twitter, index) => {
            const conference = document.querySelectorAll('.article-wrapper')[index];
            const conferenceName = conference.querySelector('h2').innerText;
            const conferenceDate = conference.querySelector('p:nth-child(2)').innerText;
            const conferenceLocation = conference.querySelector('p:nth-child(3)').innerText;
            const msg = encodeURIComponent(`Check out this conference: ${conferenceName}, Date: ${conferenceDate}, Location: ${conferenceLocation}`);

            twitter.href = `http://twitter.com/share?text=${msg}`;
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.3.0/main.min.js" integrity="sha256-DBxkGZLxKsLKhz054qUpBqtotG00r9AELGpSigJujLg=" crossorigin="anonymous"></script>

    <script>
        window.onload = () => {
            let calendarElt = document.querySelector("#calendar-holder")

            let calendar = new FullCalendar.Calendar(calendarElt, {
                initialView: 'dayGridMonth', // Display only the days of the month
                locale: 'fr',
                timeZone: 'Europe/Paris',
                headerToolbar: {
                    start: 'prev,next today',
                    center: 'title',
                    end: 'dayGridMonth,timeGridWeek'
                },
                events: {{ data|raw }},
                eventResizableFromStart: true,
                eventClick: function(info) {
                    // Open modal when event is clicked
                    modal.style.display = "block";
                    console.log(info.event.id)
                    // Retrieve and set the event details inside the modal
                    var eventTitle = info.event.title;
                    var eventDate = info.event.start;
                    var eventLocation = info.event.extendedProps.location;
                    document.getElementById("articleDetails").innerHTML = "<strong>" + eventTitle + "</strong><br>Date: " + eventDate + "<br>Location: " + eventLocation;
                }
            })

            calendar.render()
        }
    </script>
    <script>
        // Get the modal
        var modal = document.getElementById("myModal");

        // Get the button that opens the modal
        var readMoreButtons = document.querySelectorAll(".read-more");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal
        readMoreButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                modal.style.display = "block";
                // Retrieve and set the article details inside the modal
                var articleTitle = this.parentElement.querySelector("h2").textContent;
                var articleText = this.parentElement.querySelector("p").textContent;
                document.getElementById("articleDetails").innerHTML = "<strong>" + articleTitle + "</strong><br>" + articleText;
            });
        });

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        };

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        };

    </script>

{% endblock %}

{% block sessions %}
    {% for session in sessions %}
        <div class="col-lg-3">
            <div class="service-item first-service" style="height: 200px">
                <div class="icon"></div>
                <h4>{{ session.sessionname }}</h4>
                <p>Start from <a style="font-weight: bold"> {{  session.starttime ? session.starttime|date('H:i') : ''  }}</a>  To <a style="font-weight: bold">  {{ session.endtime ? session.endtime|date('H:i') : '' }} </a>. </p>
                {% set topic_count = 0 %}
                {% for topic in allTopics %}
                    {% if topic.idsession.id == session.id %}
                        {% set topic_count = topic_count + 1 %}
                    {% endif %}
                {% endfor %}
                <div class="text-button">
                    <a href="{{ path('app_front_show_by_id', {'id': session.id}) }}#section_3">{{ topic_count }} Topics <i class="fa fa-arrow-right"></i></a>
                </div>
            </div>
        </div>
    {% endfor %}
{% endblock %}

{% block topics %}
    {% for topic in topics %}
        <li>
            <h4 class="text-white mb-3">{{ topic.topicname  }}</h4>

            <p class="text-white">{{ topic.topicdescription }}</p>

            <div class="icon-holder">
                <h4>{{ loop.index }}</h4>
            </div>
        </li>
    {% endfor %}


{% endblock %}


{% block presence %}
    <style>
        table {
            margin-top: 40px;
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #6aabec;
        }

        .th-data td {
            /* Style for td under th */
            font-weight: bold;

        }
    </style>
    <div style="display: flex;gap: 30px">
        <div class="front-widget" style="">
            <h1>Info</h1>
            <div>
                <table>
                    <tr>
                        <th>Current Conference</th>
                        {% if conference is not none %}
                            <td>{{ conference.nom }}</td>
                        {% else %}
                            <td>---</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <th>Places</th>

                        <td id="presenceNbr">
                            {% if conference is not none %}

                                {{ place.capacite}}
                            {% else %}
                                ---
                            {% endif %}
                        </td>

                    </tr>
                    <tr>

                        <th>Current Session</th>
                        {% if session is not none %}
                            <td>{{ session.sessionname}}</td>
                        {% else %}
                            <td>---</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <th>Location</th>
                        {% if conference is not none %}
                            <td>{{ place.label }}</td>
                        {% else %}
                            <td>---</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <th>Government</th>
                        {% if conference is not none %}
                            <td>{{ place.gouvernourat }}</td>
                        {% else %}
                            <td>---</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <th>City</th>
                        {% if conference is not none %}
                            <td>{{ place.ville }}</td>
                        {% else %}
                            <td>---</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <th>Weather</th>
                        {% if conference is not none %}
                            <td>{{ weather -273.15}} °C </td>
                        {% else %}
                            <td>---</td>
                        {% endif %}
                    </tr>

                </table>
            </div>

        </div>
        <div class="front-widget">
            <h1>Place Available</h1>
            <div class="chair-room">
                {% set line = 0 %}
                {% set column = 1 %}
                {% set alphabet = ['B','B','B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'] %}
                <div class="chair-line">
                    <div style="font-family: 'SF Display Pro', sans-serif; font-weight:700; width: 80px;color: #575656">Line A</div>
                    {% for i in range(0, place.capacite) %}
                    {% if line == 13 %}
                    {% set line = 0 %}
                </div>
                <div class="chair-line">
                    {% set column = column + 1 %}
                    <div style="font-family: 'SF Display Pro', sans-serif; font-weight:700; width: 80px;color: #575656">Line {{ alphabet[column] }}</div>
                    {% endif %}

                    {% if i < participant | length %}
                        <div class="chair-available popover-trigger">
                            {{ i }}
                            <div class="popover">
                                {{ participant[i].username }}
                            </div>
                        </div>
                    {% else %}
                        <div class="chair-nonavailable">
                            {{ i }}
                        </div>
                    {% endif %}
                    {% set line = line + 1 %}
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>



    <script>

        const eventSource = new EventSource("{{ mercure('http://192.168.1.13/rfid')|escape('js') }}");
        eventSource.onmessage = event => {
            const eventData = JSON.parse(event.data);
            if (eventData.status === "in") {
                var no = true;
                //add for and parcourir one by one to fverif
                {% for particip in participant %}
                if( '{{ particip.username }}'==eventData.username ){
                    no =false;

                }
                {% endfor %}
                if(no){
                    const chairToMakeAvailable = document.querySelector('.chair-nonavailable');
                    if (chairToMakeAvailable) {
                        chairToMakeAvailable.classList.remove('chair-nonavailable');
                        chairToMakeAvailable.classList.add('chair-available', 'popover-trigger');

                        const popoverDiv = document.createElement('div');
                        popoverDiv.classList.add('popover');
                        popoverDiv.textContent = eventData.username; // Assuming participant[i].username contains the username
                        chairToMakeAvailable.appendChild(popoverDiv);

                        // Call the function to initialize popover functionality
                        initializePopovers();
                    }
                }
            }
        };

        // Function to initialize popover functionality
        function initializePopovers() {
            var popoverTriggers = document.querySelectorAll(".popover-trigger");

            popoverTriggers.forEach(function(trigger) {
                trigger.addEventListener("mouseenter", function() {
                    var popover = this.querySelector(".popover");
                    popover.classList.add("active");
                });

                trigger.addEventListener("mouseleave", function() {
                    var popover = this.querySelector(".popover");
                    popover.classList.remove("active");
                });
            });

            // Close the popover when clicking outside of it
            window.addEventListener("click", function(event) {
                var popovers = document.querySelectorAll(".popover");
                popovers.forEach(function(popover) {
                    if (!popover.contains(event.target)) {
                        popover.classList.remove("active");
                    }
                });
            });
        }

        // Call the function when the DOM content is loaded
        document.addEventListener("DOMContentLoaded", initializePopovers);

    </script>
{% endblock %}